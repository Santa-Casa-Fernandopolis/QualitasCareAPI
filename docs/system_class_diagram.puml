@startuml
skinparam backgroundColor #FFFFFF
skinparam packageStyle rect
skinparam classAttributeIconSize 0
skinparam linetype ortho
hide empty members

' ============ pacotes ============
' ================== Pacote: observability.security ==================
package "com.erp.qualitascareapi.observability.security" as observability.security.obs_sec {

  class SecurityAuditLogController <<RestController>> {
    +search(from: Instant, to: Instant, username: String,
            eventType: SecurityAuditEventType, traceId: String,
            page: int = 0, size: int = 20)
      : Page<SecurityAuditLogResponse>
    --
    {static} @RequestMapping("/api/logs/security")
    GET /api/logs/security
  }

  class SecurityAuditQueryService <<Service>>

  class SecurityAuditEventFilter <<Filter>> {
    -from: Instant
    -to: Instant
    -username: String
    -eventType: SecurityAuditEventType
    -traceId: String
  }

  class SecurityAuditLogResponse <<DTO>> {
    -id: Long
    -timestamp: Instant
    -username: String
    -eventType: SecurityAuditEventType
    -clientIp: String
    -traceId: String
    -description: String
  }

  class SecurityAuditEvent <<Entity>> {
    -id: Long
    -timestamp: Instant
    -username: String
    -eventType: SecurityAuditEventType
    -clientIp: String
    -traceId: String
    -description: String
  }

  enum SecurityAuditEventType {
    AUTHENTICATION_SUCCESS
    AUTHENTICATION_FAILURE
    AUTHORIZATION_FAILURE
  }

  ' Rela√ß√µes
  observability.security.SecurityAuditLogController --> observability.security.SecurityAuditQueryService : uses
  observability.security.SecurityAuditLogController --> observability.security.SecurityAuditLogResponse
  observability.security.SecurityAuditLogController --> observability.security.SecurityAuditEventFilter
  observability.security.SecurityAuditLogResponse --> observability.security.SecurityAuditEventType
  observability.security.SecurityAuditEvent --> observability.security.SecurityAuditEventType
  observability.security.SecurityAuditQueryService --> observability.security.SecurityAuditEvent : returns Page<>
}

' ================== Pacote: observability.logging ==================
package "com.erp.qualitascareapi.observability.logging" as observability.logging.obs_log {

  class OperationalLogController <<RestController>> {
    +search(from: Instant, to: Instant, method: String,
            status: Integer, userId: String, traceId: String, path: String,
            page: int = 0, size: int = 20)
      : Page<RequestLogResponse>
    --
    {static} @RequestMapping("/api/logs/operational")
    GET /api/logs/operational
  }

  class RequestLogQueryService <<Service>>

  class RequestLogFilter <<Filter>> {
    -from: Instant
    -to: Instant
    -method: String
    -status: Integer
    -userId: String
    -traceId: String
    -path: String
  }

  class RequestLogResponse <<DTO>> {
    -id: Long
    -timestamp: Instant
    -method: String
    -path: String
    -status: int
    -durationMs: long
    -traceId: String
    -userId: String
    -clientIp: String
    -httpVersion: String
    -contentLength: Long
  }

  class RequestLog <<Entity>> {
    -id: Long
    -timestamp: Instant
    -method: String
    -path: String
    -status: int
    -durationMs: long
    -traceId: String
    -userId: String
    -clientIp: String
    -httpVersion: String
    -contentLength: Long
  }

  ' Rela√ß√µes
  observability.logging.OperationalLogController --> observability.logging.RequestLogQueryService : uses
  observability.logging.OperationalLogController --> observability.logging.RequestLogResponse
  observability.logging.OperationalLogController --> observability.logging.RequestLogFilter
  observability.logging.RequestLogQueryService --> observability.logging.RequestLog : returns Page<>
}

' ================== Pacote: observability.audit (data/envers) ==================
package "com.erp.qualitascareapi.observability.audit" as observability.audit.obs_audit {

  class DataAuditLogController <<RestController>> {
    +getRevisions(entityAlias: String, id: String) : List<DataAuditEntry>
    --
    {static} @RequestMapping("/api/logs/data")
    GET /api/logs/data/{entityAlias}/{id}
  }

  class DataAuditQueryService <<Service>>

  class DataAuditEntry <<DTO>> {
    -revId: Long
    -revTimestamp: Instant
    -username: String
    -clientIp: String
    -changeType: String    ' INSERT/UPDATE/DELETE
    -payloadDiff: String   ' opcional: JSON diff/patch
  }

  ' Rela√ß√µes
  observability.audit.DataAuditLogController --> observability.audit.DataAuditQueryService : uses
  observability.audit.DataAuditLogController --> observability.audit.DataAuditEntry
  observability.audit.DataAuditQueryService --> observability.audit.DataAuditEntry : returns List<>
}

' ================== Notas ==================
note right of observability.security.obs_sec.SecurityAuditLogController
Orderna√ß√£o por timestamp DESC (PageRequest).
Filtra por per√≠odo, usu√°rio, tipo e traceId.
end note

note right of observability.logging.obs_log.OperationalLogController
Consulta logs de acesso/operacionais (RequestLog).
Suporta filtro por m√©todo, status, userId, traceId e path.
end note

note right of observability.audit.obs_audit.DataAuditLogController
Exibe revis√µes (Envers) por entidade e ID l√≥gico.
√ötil para auditoria de dados regulat√≥ria (ONA/Anvisa).
end note

package "com.erp.qualitascareapi.iam.api" as iam.api {

  class UserController <<RestController>> {
    +list(pageable: Pageable): Page<UserDto>
    +get(id: Long): UserDto
    +create(request: UserCreateRequest): UserDto
    +update(id: Long, request: UserUpdateRequest): UserDto
    +delete(id: Long): void
    --
    {static} @RequestMapping("/api/users")
    {static} @PreAuthorize("hasRole('SYSTEM_ADMIN')")
  }

  class TenantController <<RestController>> {
    +list(pageable: Pageable): Page<TenantDto>
    +get(id: Long): TenantDto
    +create(request: TenantRequest): TenantDto
    +update(id: Long, request: TenantRequest): TenantDto
    +delete(id: Long): void
    --
    {static} @RequestMapping("/api/tenants")
    {static} @PreAuthorize("hasRole('SYSTEM_ADMIN')")
  }
}

package "com.erp.qualitascareapi.iam.application" as iam.app {
  class UserService <<Service>>
  class TenantService <<Service>>
}

package "com.erp.qualitascareapi.iam.api.dto" as iam.dto {
  class UserDto <<DTO>>
  class UserCreateRequest <<Request>>
  class UserUpdateRequest <<Request>>

  class TenantDto <<DTO>>
  class TenantRequest <<Request>>
}

' ========== RELA√á√ïES CONTROLLER ‚Üí SERVICE ==========
iam.api.UserController --> iam.app.UserService : uses
iam.api.TenantController --> iam.app.TenantService : uses

' ========== RELA√á√ïES CONTROLLER ‚Üí DTO ==========
iam.api.UserController --> iam.dto.UserDto
iam.api.UserController --> iam.dto.UserCreateRequest
iam.api.UserController --> iam.dto.UserUpdateRequest

iam.api.TenantController --> iam.dto.TenantDto
iam.api.TenantController --> iam.dto.TenantRequest

' ========== NOTAS ==========
note right of iam.api.UserController
  CRUD de Usu√°rios
  - Cria√ß√£o e atualiza√ß√£o via DTOs espec√≠ficos
  - Somente SYSTEM_ADMIN pode acessar
end note

note right of iam.api.TenantController
  CRUD de Tenants (Hospitais/Unidades)
  - Controla isolamento multi-tenant
  - Acesso restrito a SYSTEM_ADMIN
end note

package "com.erp.qualitascareapi.security.api" as security.api {

  class AuthController <<RestController>> {
      +login(request: LoginRequest): LoginResponse
      --
      {static} @RequestMapping("/api/auth")
      POST /api/auth/login
    }

  class UserPermissionOverrideController <<RestController>> {
    +list(pageable: Pageable): Page<UserPermissionOverrideDto>
    +get(id: Long): UserPermissionOverrideDto
    +create(request: UserPermissionOverrideRequest): UserPermissionOverrideDto
    +update(id: Long, request: UserPermissionOverrideRequest): UserPermissionOverrideDto
    +delete(id: Long): void
    --
    {static} @RequestMapping("/api/user-overrides")
    {static} @PreAuthorize("hasRole('SYSTEM_ADMIN')")
  }

  class RolePermissionController <<RestController>> {
    +list(pageable: Pageable): Page<RolePermissionDto>
    +get(id: Long): RolePermissionDto
    +create(request: RolePermissionRequest): RolePermissionDto
    +update(id: Long, request: RolePermissionRequest): RolePermissionDto
    +delete(id: Long): void
    --
    {static} @RequestMapping("/api/role-permissions")
    {static} @PreAuthorize("hasRole('SYSTEM_ADMIN')")
  }

  class RoleController <<RestController>> {
    +list(pageable: Pageable): Page<RoleDto>
    +get(id: Long): RoleDto
    +create(request: RoleRequest): RoleDto
    +update(id: Long, request: RoleRequest): RoleDto
    +delete(id: Long): void
    --
    {static} @RequestMapping("/api/roles")
    {static} @PreAuthorize("hasRole('SYSTEM_ADMIN')")
  }

  class PolicyController <<RestController>> {
    +list(pageable: Pageable): Page<PolicyDto>
    +get(id: Long): PolicyDto
    +create(request: PolicyRequest): PolicyDto
    +update(id: Long, request: PolicyRequest): PolicyDto
    +delete(id: Long): void
    --
    {static} @RequestMapping("/api/policies")
    {static} @PreAuthorize("hasRole('SYSTEM_ADMIN')")
  }

  class PermissionController <<RestController>> {
    +list(pageable: Pageable): Page<PermissionDto>
    +get(id: Long): PermissionDto
    +create(request: PermissionRequest): PermissionDto
    +update(id: Long, request: PermissionRequest): PermissionDto
    +delete(id: Long): void
    --
    {static} @RequestMapping("/api/permissions")
    {static} @PreAuthorize("hasRole('SYSTEM_ADMIN')")
  }
}

package "com.erp.qualitascareapi.security.application" as security.app {
  class UserPermissionOverrideService <<Service>>
  class RolePermissionService <<Service>>
  class RoleService <<Service>>
  class PolicyService <<Service>>
  class PermissionService <<Service>>
  class TokenService <<Service>> {
      +generateToken(auth: Authentication): LoginResponse
    }
}

package "com.erp.qualitascareapi.security.api.dto" as security.dto {
  class UserPermissionOverrideDto <<DTO>>
  class UserPermissionOverrideRequest <<Request>>

  class RolePermissionDto <<DTO>>
  class RolePermissionRequest <<Request>>

  class RoleDto <<DTO>>
  class RoleRequest <<Request>>

  class PolicyDto <<DTO>>
  class PolicyRequest <<Request>>

  class PermissionDto <<DTO>>
  class PermissionRequest <<Request>>

  class LoginRequest <<DTO>> {
      +username(): String
      +password(): String
      +tenantCode(): String
    }

    class LoginResponse <<DTO>> {
      +token: String
      +expiresAt: Instant
      +roles: List<String>
    }
}

' ================== PACOTE: Spring Security ==================
package "org.springframework.security.authentication" as spring_auth {
  class AuthenticationManager {
    +authenticate(auth: Authentication): Authentication
  }

  class UsernamePasswordAuthenticationToken {
    +unauthenticated(username: String, password: String)
  }
}

package "org.springframework.security.core" as spring_core {
  interface Authentication
}

' ============ depend√™ncias controller -> service ============
api.AuthController --> spring_auth.AuthenticationManager : uses
api.AuthController --> app.TokenService : uses
api.AuthController --> dto.LoginRequest : consumes
api.AuthController --> dto.LoginResponse : returns
app.TokenService --> dto.LoginResponse
spring_auth.AuthenticationManager --> spring_core.Authentication
spring_auth.UsernamePasswordAuthenticationToken --> spring_core.Authentication

' ================== NOTAS ==================
note right of api.AuthController
  üîê Fluxo de autentica√ß√£o JWT:
  1Ô∏è‚É£ Recebe LoginRequest (username, password, tenantCode)
  2Ô∏è‚É£ Concatena tenantCode ao username (ex: joao@HOSP001)
  3Ô∏è‚É£ Autentica via AuthenticationManager
  4Ô∏è‚É£ Gera token JWT via TokenService
  5Ô∏è‚É£ Retorna LoginResponse (token + expira√ß√£o + roles)
end note

note right of app.TokenService
  Implementa a gera√ß√£o e assinatura de tokens JWT
  (ex: usando secret ou chave p√∫blica/privada RSA)
end note

security.api.UserPermissionOverrideController --> security.app.UserPermissionOverrideService : uses
security.api.RolePermissionController        --> security.app.RolePermissionService        : uses
security.api.RoleController                  --> security.app.RoleService                  : uses
security.api.PolicyController                --> security.app.PolicyService                : uses
security.api.PermissionController            --> security.app.PermissionService            : uses

' ============ assinaturas de retorno / par√¢metros (associa√ß√£o conceitual) ============
security.api.UserPermissionOverrideController --> security.dto.UserPermissionOverrideDto
security.api.UserPermissionOverrideController --> security.dto.UserPermissionOverrideRequest

security.api.RolePermissionController --> security.dto.RolePermissionDto
security.api.RolePermissionController --> security.dto.RolePermissionRequest

security.api.RoleController --> security.dto.RoleDto
security.api.RoleController --> security.dto.RoleRequest

security.api.PolicyController --> security.dto.PolicyDto
security.api.PolicyController --> security.dto.PolicyRequest

security.api.PermissionController --> security.dto.PermissionDto
security.api.PermissionController --> security.dto.PermissionRequest

' ============ notas √∫teis ============
note right of security.api.UserPermissionOverrideController
  HTTP 201 em create()
  HTTP 204 em delete()
end note

note right of security.api.RolePermissionController
  Pagina√ß√£o via Pageable / Page<T>
end note

note right of security.api.PolicyController
  Escopo administrativo:
  hasRole('SYSTEM_ADMIN')
end note

@enduml


@enduml
