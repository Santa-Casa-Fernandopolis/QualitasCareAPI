@startuml
skinparam backgroundColor #FFFFFF
skinparam packageStyle rect
skinparam classAttributeIconSize 0
skinparam linetype ortho

package "QualitasCare API" {
  class QualitasCareApiApplication

  package "Configuration" {
    class SecurityConfig
    class ObservabilityConfiguration
    class DevTestDataInitializer
    class AuthorizationServerConfig
    class Jwks
  }

  package "IAM" {
    package "API" {
      class TenantController <<RestController>> {
        +listTenants()
        +getTenant(id)
        +createTenant()
        +updateTenant(id)
        +deleteTenant(id)
      }
      class UserController <<RestController>> {
        +listUsers()
        +getUser(id)
        +createUser()
        +updateUser(id)
        +deleteUser(id)
      }
    }
    package "Application" {
      class TenantService <<Service>>
      class UserService <<Service>>
      class LocalUserDetailsService <<Service>>
      class AuthenticatedUserDetails
    }
    package "Repository" {
      interface TenantRepository <<Repository>>
      interface UserRepository <<Repository>>
    }
    package "Domain" {
      class Tenant {
        +id: Long
        +code: String
        +name: String
        +active: boolean
      }
      class User {
        +id: Long
        +username: String
        +passwordHash: String
        +fullName: String
        +department: String
        +status: UserStatus
        +origin: IdentityOrigin
        +createdAt: LocalDateTime
        +activatedAt: LocalDateTime
        +expiresAt: LocalDateTime
        +updatedAt: LocalDateTime
      }
    }
  }

  package "Security" {
    package "API" {
      class RoleController <<RestController>> {
        +listRoles()
        +getRole(id)
        +createRole()
        +updateRole(id)
        +deleteRole(id)
      }
      class PermissionController <<RestController>> {
        +listPermissions()
        +getPermission(id)
        +createPermission()
        +updatePermission(id)
        +deletePermission(id)
      }
      class PolicyController <<RestController>> {
        +listPolicies()
        +getPolicy(id)
        +createPolicy()
        +updatePolicy(id)
        +deletePolicy(id)
      }
      class RolePermissionController <<RestController>> {
        +listRolePermissions()
        +getRolePermission(id)
        +createRolePermission()
        +updateRolePermission(id)
        +deleteRolePermission(id)
      }
      class UserPermissionOverrideController <<RestController>> {
        +listUserOverrides()
        +getUserOverride(id)
        +createUserOverride()
        +updateUserOverride(id)
        +deleteUserOverride(id)
      }
    }
    package "Application" {
      class RoleService <<Service>>
      class PermissionService <<Service>>
      class PolicyService <<Service>>
      class RolePermissionService <<Service>>
      class UserPermissionOverrideService <<Service>>
      class AccessDecisionServiceImpl <<Service>>
      interface AccessDecisionService
      class PolicyEvaluator
      class TargetLoader
      class CurrentUserExtractor
    }
    package "Repository" {
      interface RoleRepository <<Repository>>
      interface PermissionRepository <<Repository>>
      interface PolicyRepository <<Repository>>
      interface RolePermissionRepository <<Repository>>
      interface UserPermissionOverrideRepository <<Repository>>
    }
    package "Domain" {
      class Role {
        +id: Long
        +name: String
        +description: String
      }
      class Permission {
        +id: Long
        +resource: ResourceType
        +action: Action
        +feature: String
        +code: String
      }
      class Policy {
        +id: Long
        +resource: ResourceType
        +action: Action
        +feature: String
        +effect: Effect
        +enabled: boolean
        +priority: int
        +description: String
      }
      class PolicyCondition {
        +id: Long
        +type: String
        +operator: String
        +value: String
      }
      class RolePermission {
        +id: Long
      }
      class UserPermissionOverride {
        +id: Long
        +resource: ResourceType
        +action: Action
        +feature: String
        +effect: Effect
        +priority: int
        +reason: String
        +validFrom: LocalDateTime
        +validUntil: LocalDateTime
        +approved: boolean
        +dualApprovalRequired: boolean
        +requestedBy: String
        +approvedBy: String
        +approvedAt: LocalDateTime
      }
    }
  }

  package "Observability" {
    package "Security Audit" {
      class SecurityAuditLogController <<RestController>> {
        +getSecurityLogs()
      }
      class SecurityAuditQueryService <<Service>>
      interface SecurityAuditEventRepository <<Repository>>
      class SecurityAuditEvent {
        +id: Long
        +timestamp: Instant
        +username: String
        +eventType: SecurityAuditEventType
        +clientIp: String
        +traceId: String
        +description: String
      }
      enum SecurityAuditEventType {
        AUTHENTICATION_SUCCESS
        AUTHENTICATION_FAILURE
        AUTHORIZATION_FAILURE
      }
      class SecurityAuditEventListener
      class SecurityAuditEventFilter
    }
    package "Data Audit" {
      class DataAuditLogController <<RestController>> {
        +getDataLog(entityAlias, id)
      }
      class DataAuditQueryService <<Service>>
      class AuditRevisionEntity {
        +id: Long
        +timestamp: long
        +username: String
        +clientIp: String
      }
      class AuditRevisionListener
      class DataAuditEntry {
        +revisionId: Long
        +timestamp: Instant
        +username: String
        +clientIp: String
        +state: Map<String, Object>
      }
    }
    package "Logging" {
      class OperationalLogController <<RestController>> {
        +getOperationalLogs()
      }
      class RequestLogQueryService <<Service>>
      interface RequestLogRepository <<Repository>>
      class RequestLog {
        +id: Long
        +timestamp: Instant
        +method: String
        +path: String
        +status: int
        +durationMs: long
        +traceId: String
        +userId: String
        +clientIp: String
        +httpVersion: String
        +contentLength: Long
      }
      class RequestLoggingFilter
      class RequestLogFilter
      class CorrelationFilter
    }
  }
}

QualitasCareApiApplication --> SecurityConfig
QualitasCareApiApplication --> ObservabilityConfiguration
QualitasCareApiApplication --> AuthorizationServerConfig
DevTestDataInitializer --> TenantService
DevTestDataInitializer --> RoleService
DevTestDataInitializer --> PermissionService
DevTestDataInitializer --> PolicyService
DevTestDataInitializer --> UserService

TenantController --> TenantService
TenantService --> TenantRepository
TenantService --> Tenant
UserController --> UserService
UserService --> UserRepository
UserService --> TenantRepository
UserService --> RoleRepository
UserService --> User
UserService --> Tenant

RoleController --> RoleService
PermissionController --> PermissionService
PolicyController --> PolicyService
RolePermissionController --> RolePermissionService
UserPermissionOverrideController --> UserPermissionOverrideService

RoleService --> RoleRepository
PermissionService --> PermissionRepository
PolicyService --> PolicyRepository
RolePermissionService --> RolePermissionRepository
UserPermissionOverrideService --> UserPermissionOverrideRepository

SecurityAuditLogController --> SecurityAuditQueryService
SecurityAuditQueryService --> SecurityAuditEventRepository
SecurityAuditEventListener --> SecurityAuditEventRepository
SecurityAuditEventFilter --> SecurityAuditEventRepository

DataAuditLogController --> DataAuditQueryService
DataAuditQueryService --> AuditRevisionEntity
AuditRevisionListener --> AuditRevisionEntity

OperationalLogController --> RequestLogQueryService
RequestLogQueryService --> RequestLogRepository
RequestLoggingFilter --> RequestLogRepository
RequestLogFilter --> RequestLogRepository
CorrelationFilter --> RequestLogRepository

@enduml
