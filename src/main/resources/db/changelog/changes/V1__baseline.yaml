databaseChangeLog:
  - changeSet:
      id: v1-001-tenants-roles-users
      author: qualitas
      changes:
        - createTable:
            tableName: tenants
            columns:
              - column: { name: id, type: BIGSERIAL, constraints: { primaryKey: true } }
              - column: { name: name, type: VARCHAR(120), constraints: { nullable: false, unique: true } }

        - createTable:
            tableName: roles
            columns:
              - column: { name: id, type: BIGSERIAL, constraints: { primaryKey: true } }
              - column: { name: name, type: VARCHAR(80), constraints: { nullable: false, unique: true } }

        - createTable:
            tableName: users
            columns:
              - column: { name: id, type: BIGSERIAL, constraints: { primaryKey: true } }
              - column: { name: username, type: VARCHAR(120), constraints: { nullable: false, unique: true } }
              - column: { name: password, type: VARCHAR(255), constraints: { nullable: false } }
              - column: { name: enabled, type: BOOLEAN, defaultValueBoolean: true }
              - column: { name: tenant_id, type: BIGINT }

        - addForeignKeyConstraint:
            baseTableName: users
            baseColumnNames: tenant_id
            referencedTableName: tenants
            referencedColumnNames: id
            constraintName: fk_users_tenant

        - createTable:
            tableName: users_roles
            columns:
              - column: { name: user_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: role_id, type: BIGINT, constraints: { nullable: false } }
        - addPrimaryKey:
            tableName: users_roles
            columnNames: user_id, role_id
            constraintName: pk_users_roles
        - addForeignKeyConstraint:
            baseTableName: users_roles
            baseColumnNames: user_id
            referencedTableName: users
            referencedColumnNames: id
            constraintName: fk_ur_user
        - addForeignKeyConstraint:
            baseTableName: users_roles
            baseColumnNames: role_id
            referencedTableName: roles
            referencedColumnNames: id
            constraintName: fk_ur_role

  - changeSet:
      id: v1-002-permissions-policies
      author: qualitas
      changes:
        - createTable:
            tableName: permissions
            columns:
              - column: { name: id, type: BIGSERIAL, constraints: { primaryKey: true } }
              - column: { name: resource, type: VARCHAR(40), constraints: { nullable: false } }
              - column: { name: action, type: VARCHAR(40), constraints: { nullable: false } }
              - column: { name: feature, type: VARCHAR(80) }
              - column: { name: tenant_id, type: BIGINT }
              - column: { name: code, type: VARCHAR(120) }
        - createIndex:
            tableName: permissions
            indexName: idx_perm_scope
            columns:
              - column: { name: resource }
              - column: { name: action }
              - column: { name: feature }

        - createTable:
            tableName: policies
            columns:
              - column: { name: id, type: BIGSERIAL, constraints: { primaryKey: true } }
              - column: { name: resource, type: VARCHAR(40), constraints: { nullable: false } }
              - column: { name: action, type: VARCHAR(40), constraints: { nullable: false } }
              - column: { name: feature, type: VARCHAR(80) }
              - column: { name: effect, type: VARCHAR(20), constraints: { nullable: false } }
              - column: { name: enabled, type: BOOLEAN, defaultValueBoolean: true }
              - column: { name: priority, type: INTEGER, defaultValueNumeric: 100 }
              - column: { name: description, type: VARCHAR(255) }
              - column: { name: tenant_id, type: BIGINT }

        - createTable:
            tableName: policy_conditions
            columns:
              - column: { name: id, type: BIGSERIAL, constraints: { primaryKey: true } }
              - column: { name: policy_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: cond_key, type: VARCHAR(80), constraints: { nullable: false } }     # ex.: TARGET_DEPARTMENT
              - column: { name: operator, type: VARCHAR(20), constraints: { nullable: false } }     # ex.: EQ, IN, NE
              - column: { name: cond_value, type: VARCHAR(200), constraints: { nullable: false } }  # ex.: CURRENT_DEPT, "UTI|CME"
        - addForeignKeyConstraint:
            baseTableName: policy_conditions
            baseColumnNames: policy_id
            referencedTableName: policies
            referencedColumnNames: id
            constraintName: fk_policy_condition_policy

        - createTable:
            tableName: policy_roles
            columns:
              - column: { name: policy_id, type: BIGINT, constraints: { nullable: false } }
              - column: { name: role_id, type: BIGINT, constraints: { nullable: false } }
        - addPrimaryKey:
            tableName: policy_roles
            columnNames: policy_id, role_id
            constraintName: pk_policy_roles
        - addForeignKeyConstraint:
            baseTableName: policy_roles
            baseColumnNames: policy_id
            referencedTableName: policies
            referencedColumnNames: id
            constraintName: fk_pr_policy
        - addForeignKeyConstraint:
            baseTableName: policy_roles
            baseColumnNames: role_id
            referencedTableName: roles
            referencedColumnNames: id
            constraintName: fk_pr_role
